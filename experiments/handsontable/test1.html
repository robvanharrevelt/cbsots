<!doctype html>

<script src="/home/rob/R/site-library/rhandsontable/htmlwidgets/lib/handsontable/handsontable.full.min.js"></script>

<link rel="stylesheet" media="screen"
                       href="/home/rob/R/site-library/rhandsontable/htmlwidgets/lib/handsontable/handsontable.full.min.css">

<p>

Enter a search term

<br>

<input type="text" id="search_field">
<button id="next_button">Next</button>
<button id="prev_button">Previous</button>

<p>

<div id="example"></div>

<script>

var data = [
     {id: 1, name: 'TedX', isActive: true, color: 'orange', date: '2015-01-01'},
     {id: 2, name: 'John', isActive: false, color: 'black', date: null},
     {id: 3, name: 'Al', isActive: true, color: 'red', date: null},
     {id: 4, name: 'Ben', isActive: false, color: 'blue', date: null},
     {id: 5, name: 'Rene', isActive: true, color: 'blue', date: null},
     {id: 6, name: 'Jan', isActive: true, color: 'blue', date: null},
     {id: 7, name: 'Alex', isActive: false, color: 'blue', date: null},
     {id: 8, name: 'Anita', isActive: false, color: 'blue', date: null},
     {id: 9, name: 'Klaas', isActive: false, color: 'blue', date: null},
     {id: 10, name: 'Arie', isActive: false, color: 'blue', date: null},
     {id: 11, name: 'Kees', isActive: false, color: 'blue', date: null},
     {id: 12, name: 'Marie', isActive: false, color: 'purple', date: null},
     {id: 13, name: 'Paul', isActive: false, color: 'blue', date: null},
     {id: 14, name: 'Henk', isActive: true, color: 'blue', date: null},
     {id: 15, name: 'Leo', isActive: false, color: 'blue', date: null},
     {id: 17, name: 'Geert', isActive: false, color: 'blue', date: null},
     {id: 18, name: 'Mark', isActive: false, color: 'green', date: null},
     {id: 19, name: 'Frans', isActive: true, color: 'blue', date: null},
     {id: 20, name: 'Anita', isActive: false, color: 'blue', date: null},
     {id: 21, name: 'Koen', isActive: true, color: 'blue', date: null},
     {id: 22, name: 'Lisa', isActive: false, color: 'blue', date: null},
     {id: 23, name: 'Erwin', isActive: false, color: 'blue', date: null},
     {id: 24, name: 'Fred', isActive: true, color: 'blue', date: null},
     {id: 25, name: 'PeterX', isActive: false, color: 'blue', date: null},
     {id: 26, name: 'Vera', isActive: false, color: 'blue', date: null}
];

// the number of the columns with boolean values. This column should not be 
// searched in.
var BOOLEAN_COL = 2;

var container = document.getElementById('example');

var hot = new Handsontable(container, {
  data: data,
  rowHeaders: true,
  columns: [
      {data: "id", type: 'text'},
      {data: "name", type: 'text'},
      {data: "isActive", type: 'checkbox'},
      {data: "date", type: 'date', dateFormat: 'YYYY-MM-DD'},
      {data: "color", type : 'text'}
    ],
  filters: true,
  dropdownMenu: true,
  height: 400,
  search: {
      callback: search_call_back
  },
  undo: true,
  contextMenu: true,
  multiSelect: false
});

function search_call_back(instance, row, col, value, result) {
   <!-- do not show search results in the column with logical values -->
   if (col != BOOLEAN_COL) {
       Handsontable.plugins.Search.DEFAULT_CALLBACK.apply(this, arguments);
   }
};

/* search_result contains the result of the latest search query.
   search_index is the index in the search_result array that is used to
   implement the Search Next and Search Previous behaviour.
*/
var search_results = [];
var search_index = 0;
var new_search_result = false;

var get_search_result = function(nxt) {
    var index = nxt ? ++search_index %search_results.length : search_index;
    // skip the column with logicals
    while (search_results[index].col == BOOLEAN_COL) {
        index = ++index % search_results.length;
    }
    search_index = index;
    return search_results[index];
}

var get_prev_search_result = function() {
    var n = search_results.length;
    var index = (n + search_index -1) % n;
    // skip the column with logicals
    while (search_results[index].col == BOOLEAN_COL) {
        var index = (n + index -1) % n;
    }
    search_index = index;
    return search_results[index];
}

Handsontable.dom.addEvent(search_field, 'keyup', 
        function (event) {
            if (event.code == "Enter" && search_results.length > 0) {
                var cell;
                if (!new_search_result) {
                    cell = get_search_result(true);
                } else {
                    cell = search_results[search_index];
                }
                hot.selectCell(cell.row, cell.col, cell.row, cell.col, true, 
                               false);
                search_field.focus();
                new_search_result = false;

            } else {
                search_results = hot.search.query(this.value);
                if (search_results.length > 0) {
                    new_search_result = true;
                    search_index = 0;
                    var cell = get_search_result(false);
                    hot.scrollViewportTo(cell.row, cell.col);
                } 
                hot.render();
            }
        });

var next_button = document.getElementById("next_button");
var prev_button = document.getElementById("prev_button");

next_button.addEventListener("click", function(event) {
    if (search_results.length > 0) {
        cell = get_search_result(true);
        hot.selectCell(cell.row, cell.col, cell.row, cell.col, true, false);
        new_search_result = false;
    }
});

prev_button.addEventListener("click", function(event) {
    if (search_results.length > 0) {
        cell = get_prev_search_result();
        hot.selectCell(cell.row, cell.col, cell.row, cell.col, true, false);
        new_search_result = false;
    }
})

</script>

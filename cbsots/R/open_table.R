# This function open a new table. All information about the table is contained in
# argument values
open_table <- function(values, input, output, debug) {
  
  table_id <- values$table_id
  table_desc <- values$table_desc

  # update new tab names for the current table
  values$names <- names(values$tables[[table_id]]$codes)
  
  #
  # create the tabels
  #
  
  make_table <- function(name) {
    tab <- isolate(values$tables[[table_id]]$codes[[name]])
    tab <- tab[ , 1:4] 
    hot_id <- get_hot_id(table_id, name)
    output[[hot_id]] <- renderCodetable(codetable(tab))
    return()
  }
  
  lapply(values$names, FUN = make_table)
  

  # 
  # observers for the tables
  #
  make_observer <- function(name) {
    hot_id <- get_hot_id(table_id, name)
    observeEvent(input[[hot_id]], {
      if (debug) cat(paste("Table", hot_id , "has changed\n"))
      if (!is.null(input[[hot_id]])) {
        df_input <- convert_codetable(input[[hot_id]])
        if (!is.null(df_input)) {
          if (debug) {
            cat("current values\n")
            print(head(df_input[, 1:3]))
          }
          values$tables[[values$table_id]]$codes[[name]][, 1:4] <- df_input
        } else if (debug) {
          cat(paste0("Something is wrong with input$", hot_id, ", 
                     check warnings\n"))
        }
      } else if (debug) {
        cat(paste0("input$", hot_id, " is NULL ...\n"))
      }
    })
  }
  
  lapply(values$names, make_observer)
  
  # 
  # prepare tabbed pane
  #
  
  make_panel <- function(name) {
    hot_id <- get_hot_id(table_id, name)
    return(tabPanel(name, codetableOutput(hot_id)))
  }
  
  output$tabel <- renderUI({
    isolate({
      myTabs <- lapply(values$names, make_panel)
      ret <- list(h3(paste("Tabel", table_desc)), br(),
                  p(), 
                  h5("Order used to create names"),
                  orderInput(inputId = "order_input", label = NULL, 
                             items = values$tables[[table_id]]$order),
                  p(),p(),
                  tags$div(
                    HTML("&#128270;"),
                    tags$input(type = "text", id = "search_field",
                               placeholder = "Search ..."),
                    tags$button(HTML("&#8249;"), class = "previous round", 
                                id = "prev_button"),
                    tags$button(HTML("&#8250;"), class = "next round", 
                                id = "next_button")
                  ),
                  p(),
                  do.call(tabsetPanel, c(list(id = "selected_tab"), myTabs)))
      
      return(ret)
    })
  })
  
  return(invisible(NULL))
}
